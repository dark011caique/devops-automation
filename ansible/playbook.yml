
---
- name: Instalar Docker no Ubuntu (compatível com Ansible em Python 3.9)
  hosts: vm
  become: yes
  vars:
    docker_gpg_key_url: https://download.docker.com/linux/ubuntu/gpg
    apt_keyring_dir: /etc/apt/keyrings
    docker_keyring: /etc/apt/keyrings/docker.gpg
    docker_list_path: /etc/apt/sources.list.d/docker.list

  pre_tasks:
    - name: Garantir que Python 3.9 existe no alvo
      ansible.builtin.stat:
        path: /usr/bin/python3.9
      register: py39

    - name: Falhar se Python 3.9 não está instalado
      ansible.builtin.fail:
        msg: "Python 3.9 não encontrado em /usr/bin/python3.9. Instale python3.9 antes de rodar este play."
      when: not py39.stat.exists

  tasks:
    - name: Instalar pacotes base via apt-get (sem python-apt)
      ansible.builtin.shell: |
        set -e
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -y
        apt-get install -y ca-certificates curl gnupg lsb-release apt-transport-https
      args:
        warn: false

    - name: Criar diretório de keyrings do APT
      ansible.builtin.file:
        path: "{{ apt_keyring_dir }}"
        state: directory
        mode: '0755'

    - name: Baixar chave GPG do Docker
      ansible.builtin.get_url:
        url: "{{ docker_gpg_key_url }}"
        dest: /tmp/docker.gpg
        mode: '0644'

    - name: Converter chave GPG para keyring
      ansible.builtin.shell: |
        set -e
        gpg --dearmor < /tmp/docker.gpg > "{{ docker_keyring }}"
        chmod 0644 "{{ docker_keyring }}"
      args:
        warn: false

    - name: Adicionar repositório oficial do Docker
      ansible.builtin.shell: |
        set -e
        arch="$(dpkg --print-architecture)"
        codename="$(lsb_release -cs)"
        echo "deb [arch=${arch} signed-by={{ docker_keyring }}] https://download.docker.com/linux/ubuntu ${codename} stable" > "{{ docker_list_path }}"
      args:
        warn: false

    - name: Atualizar cache e instalar Docker CE
      ansible.builtin.shell: |
        set -e
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -y
        apt-get install -y docker-ce docker-ce-cli containerd.io
      args:
        warn: false

    - name: Garantir grupo docker existe
      ansible.builtin.group:
        name: docker
        state: present

    - name: Adicionar usuário ao grupo Docker
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Iniciar e habilitar serviço Docker
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes

    - name: Instalar pip para Python 3.9 (se necessário)
      ansible.builtin.shell: |
        set -e
        if ! /usr/bin/python3.9 -m pip --version >/dev/null 2>&1; then
          /usr/bin/python3.9 -m ensurepip --upgrade || curl -sS https://bootstrap.pypa.io/get-pip.py | /usr/bin/python3.9
        fi
      args:
        warn: false

    - name: Instalar Docker SDK para Python (necessário para docker_container)
      ansible.builtin.shell: |
        set -e
        /usr/bin/python3.9 -m pip install --upgrade pip
        /usr/bin/python3.9 -m pip install docker
      args:
        warn: false

    - name: Executar container da aplicação Java
      community.docker.docker_container:
        name: java-api
        image: iesodias/java-api:latest
        state: started
        restart_policy: always
        published_ports:
          - "8081:8081"
      vars:
        ansible_python_interpreter: /usr/bin/python3.9
